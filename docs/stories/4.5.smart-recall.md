# Story 4.5: Smart Recall

## Status
Draft

## Story
**As a** user,
**I want** contextually relevant entries surfaced proactively,
**so that** I'm reminded of important things at the right time.

## Acceptance Criteria

1. "What to remember today" feature on home/capture view
2. Time-based relevance (entries from same day last week, etc.)
3. Keyword triggers (e.g., "today", "tomorrow", "Monday")
4. Optional push notification for important recalls
5. Dismissable recall cards
6. Settings to enable/disable smart recall
7. Works offline with cached data

## Tasks / Subtasks

- [ ] Task 1: Create smart recall algorithm (AC: 2, 3)
  - [ ] Define recall criteria (time patterns, keywords)
  - [ ] Query entries matching criteria
  - [ ] Rank by relevance/urgency
  - [ ] Return top N recall items

- [ ] Task 2: Build recall UI component (AC: 1, 5)
  - [ ] Create RecallCard component
  - [ ] Show on capture/home view
  - [ ] Dismissable with swipe or tap
  - [ ] Track dismissed items (don't show again today)

- [ ] Task 3: Implement time-based recall (AC: 2)
  - [ ] Same day last week
  - [ ] Same day last month
  - [ ] Entries created "X days ago"
  - [ ] Anniversary-type recalls

- [ ] Task 4: Implement keyword triggers (AC: 3)
  - [ ] Scan entries for date keywords
  - [ ] "today", "tomorrow", "this week", "Monday", etc.
  - [ ] Parse relative dates
  - [ ] Match against current date

- [ ] Task 5: Add push notifications (AC: 4)
  - [ ] Set up expo-notifications
  - [ ] Schedule notification for morning recall
  - [ ] Include entry snippet in notification
  - [ ] Tap notification â†’ open app to recall

- [ ] Task 6: Create recall settings (AC: 6)
  - [ ] Toggle smart recall on/off
  - [ ] Notification preferences (time, frequency)
  - [ ] Types of recall to enable

- [ ] Task 7: Offline support (AC: 7)
  - [ ] Run recall algorithm on cached entries
  - [ ] No network required for basic recall
  - [ ] Sync recall dismissals when online

## Dev Notes

### Smart Recall Algorithm
```typescript
// lib/smartRecall.ts
interface RecallItem {
  entry: Entry;
  reason: string;
  priority: number;
}

async function getSmartRecalls(entries: Entry[]): Promise<RecallItem[]> {
  const recalls: RecallItem[] = [];
  const today = new Date();

  for (const entry of entries) {
    const created = new Date(entry.created_at);

    // Time-based recalls
    if (isSameDayLastWeek(created, today)) {
      recalls.push({
        entry,
        reason: 'From this day last week',
        priority: 2
      });
    }

    if (isSameDayLastMonth(created, today)) {
      recalls.push({
        entry,
        reason: 'From this day last month',
        priority: 1
      });
    }

    // Keyword-based recalls
    const keywordMatch = checkDateKeywords(entry.content, today);
    if (keywordMatch) {
      recalls.push({
        entry,
        reason: keywordMatch.reason,
        priority: keywordMatch.priority
      });
    }
  }

  // Sort by priority and return top items
  return recalls
    .sort((a, b) => b.priority - a.priority)
    .slice(0, 5);
}

function checkDateKeywords(content: string, today: Date): { reason: string; priority: number } | null {
  const lower = content.toLowerCase();

  if (lower.includes('today') && isToday(today)) {
    return { reason: 'Mentions "today"', priority: 5 };
  }

  if (lower.includes('tomorrow')) {
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    // If created yesterday and says "tomorrow", it's today!
    return { reason: 'Tomorrow is today!', priority: 5 };
  }

  const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
  const todayName = dayNames[today.getDay()];
  if (lower.includes(todayName)) {
    return { reason: `Mentions ${todayName}`, priority: 4 };
  }

  return null;
}
```

### Recall Card Component
```tsx
// components/capture/RecallCard.tsx
function RecallCard({ item, onDismiss }: { item: RecallItem; onDismiss: () => void }) {
  return (
    <View className="bg-accent/20 border-2 border-accent rounded-sketch p-4 mb-3">
      <View className="flex-row justify-between items-start">
        <View className="flex-1">
          <Text className="font-marker text-sm text-accent mb-1">
            ðŸ’¡ {item.reason}
          </Text>
          <Text className="font-caveat text-lg" numberOfLines={2}>
            {item.entry.content}
          </Text>
        </View>
        <Pressable onPress={onDismiss} className="p-2">
          <Text className="text-muted">âœ•</Text>
        </Pressable>
      </View>

      <View className="flex-row mt-3 gap-2">
        <Pressable
          className="flex-1 bg-accent rounded-sketch p-2"
          onPress={() => openEntry(item.entry)}
        >
          <Text className="text-center font-caveat">View</Text>
        </Pressable>
        <Pressable
          className="flex-1 bg-muted rounded-sketch p-2"
          onPress={onDismiss}
        >
          <Text className="text-center font-caveat">Dismiss</Text>
        </Pressable>
      </View>
    </View>
  );
}
```

### Integration with Capture View
```tsx
// In capture.tsx
function CaptureScreen() {
  const entries = useAppStore((s) => s.entries.filter(e => !e.archived));
  const [recalls, setRecalls] = useState<RecallItem[]>([]);
  const [dismissedIds, setDismissedIds] = useState<Set<string>>(new Set());

  useEffect(() => {
    const items = getSmartRecalls(entries)
      .filter(r => !dismissedIds.has(r.entry.id));
    setRecalls(items);
  }, [entries, dismissedIds]);

  const handleDismiss = (entryId: string) => {
    setDismissedIds(prev => new Set([...prev, entryId]));
    // Persist dismissed IDs for today
    saveDismissedToday(entryId);
  };

  return (
    <View className="flex-1">
      {/* Smart Recall Section */}
      {recalls.length > 0 && (
        <View className="px-4 pt-4">
          <Text className="font-marker text-lg mb-2">Remember Today</Text>
          {recalls.map(item => (
            <RecallCard
              key={item.entry.id}
              item={item}
              onDismiss={() => handleDismiss(item.entry.id)}
            />
          ))}
        </View>
      )}

      {/* Existing card stack */}
      <CardStack entries={entries} />
    </View>
  );
}
```

### Push Notifications Setup
```typescript
// lib/notifications.ts
import * as Notifications from 'expo-notifications';

async function setupRecallNotifications() {
  const { status } = await Notifications.requestPermissionsAsync();
  if (status !== 'granted') return;

  // Schedule daily morning notification
  await Notifications.scheduleNotificationAsync({
    content: {
      title: 'ðŸ’¡ Things to Remember',
      body: 'You have items that might be relevant today',
      data: { screen: 'capture' },
    },
    trigger: {
      hour: 8,
      minute: 0,
      repeats: true,
    },
  });
}

// Handle notification tap
Notifications.addNotificationResponseReceivedListener(response => {
  const screen = response.notification.request.content.data?.screen;
  if (screen) {
    // Navigate to screen
  }
});
```

### Settings Schema
```typescript
interface RecallSettings {
  enabled: boolean;
  notificationsEnabled: boolean;
  notificationTime: string; // "08:00"
  recallTypes: {
    timeBasedWeekly: boolean;
    timeBasedMonthly: boolean;
    keywordBased: boolean;
  };
}
```

### File Locations
- Recall algorithm: `lib/smartRecall.ts`
- Recall card: `components/capture/RecallCard.tsx`
- Notifications: `lib/notifications.ts`
- Settings: `components/settings/RecallSettings.tsx`
- Capture view: `app/(tabs)/capture.tsx`

### Dependencies
```bash
bunx expo install expo-notifications
```

## Testing

### Manual Testing Required
- [ ] Open app â†’ recall cards shown if applicable
- [ ] Entry from last week â†’ appears in recalls
- [ ] Entry with "today" keyword â†’ appears in recalls
- [ ] Dismiss recall â†’ doesn't appear again today
- [ ] Tap "View" â†’ opens entry
- [ ] Notification received at configured time
- [ ] Tap notification â†’ opens app to recalls
- [ ] Settings toggle works

### Recall Quality Testing
- [ ] "Meeting tomorrow" (created yesterday) â†’ recalled today
- [ ] "Buy groceries on Monday" â†’ recalled on Monday
- [ ] Entry from same date last month â†’ recalled
- [ ] Old irrelevant entries â†’ not recalled

### Edge Cases
- [ ] No matching entries â†’ no recall section shown
- [ ] All dismissed â†’ recall section hidden
- [ ] Offline mode â†’ recall still works
- [ ] New day â†’ dismissed items reset

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
