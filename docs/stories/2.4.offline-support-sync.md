# Story 2.4: Offline Support & Sync

## Status
Draft

## Story
**As a** user,
**I want** to create and edit entries while offline,
**so that** the app works without internet connection.

## Acceptance Criteria

1. Entries cached locally (AsyncStorage / localStorage)
2. App launches and displays entries when offline
3. Offline creates queued and synced when online
4. Offline edits use optimistic updates
5. Conflict resolution: last-write-wins
6. Visual indicator when offline / syncing
7. PWA offline capability preserved

## Tasks / Subtasks

- [ ] Task 1: Set up local storage layer (AC: 1)
  - [ ] Install/configure AsyncStorage (or expo-secure-store for sensitive data)
  - [ ] Create `lib/storage.ts` with get/set/clear functions
  - [ ] Define storage keys (entries, sync_queue, last_sync)

- [ ] Task 2: Implement entry caching (AC: 1, 2)
  - [ ] Cache entries to local storage on fetch
  - [ ] Load from cache on app start (before network)
  - [ ] Update cache on every store change
  - [ ] Handle cache invalidation

- [ ] Task 3: Detect online/offline status (AC: 6)
  - [ ] Use NetInfo from `@react-native-community/netinfo`
  - [ ] Add `isOnline` state to Zustand store
  - [ ] Listen for connectivity changes
  - [ ] Web: use `navigator.onLine` and events

- [ ] Task 4: Create offline action queue (AC: 3, 4)
  - [ ] Create queue structure: { action, payload, timestamp }
  - [ ] Queue actions when offline
  - [ ] Persist queue to local storage
  - [ ] Process queue when back online

- [ ] Task 5: Implement queue processing (AC: 3, 5)
  - [ ] Process queue in order (FIFO)
  - [ ] Handle conflicts with last-write-wins
  - [ ] Retry failed actions
  - [ ] Clear queue after successful sync

- [ ] Task 6: Create sync status UI (AC: 6)
  - [ ] Show "Offline" indicator in header/status bar
  - [ ] Show "Syncing..." during queue processing
  - [ ] Show "Synced" checkmark when complete
  - [ ] Style consistent with app design

- [ ] Task 7: Handle sync conflicts (AC: 5)
  - [ ] Compare timestamps for conflicts
  - [ ] Last-write-wins resolution
  - [ ] Log conflicts for debugging
  - [ ] Future: user-selectable resolution

- [ ] Task 8: Preserve PWA offline (AC: 7)
  - [ ] Verify service worker still caches app shell
  - [ ] Test PWA offline mode
  - [ ] Ensure local storage works in PWA context

## Dev Notes

### Local Storage Setup
```typescript
// lib/storage.ts
import AsyncStorage from '@react-native-async-storage/async-storage';

const KEYS = {
  ENTRIES: 'forget_entries',
  SYNC_QUEUE: 'forget_sync_queue',
  LAST_SYNC: 'forget_last_sync',
};

export const storage = {
  async getEntries(): Promise<Entry[]> {
    const data = await AsyncStorage.getItem(KEYS.ENTRIES);
    return data ? JSON.parse(data) : [];
  },

  async setEntries(entries: Entry[]): Promise<void> {
    await AsyncStorage.setItem(KEYS.ENTRIES, JSON.stringify(entries));
  },

  async getQueue(): Promise<QueuedAction[]> {
    const data = await AsyncStorage.getItem(KEYS.SYNC_QUEUE);
    return data ? JSON.parse(data) : [];
  },

  async addToQueue(action: QueuedAction): Promise<void> {
    const queue = await this.getQueue();
    queue.push(action);
    await AsyncStorage.setItem(KEYS.SYNC_QUEUE, JSON.stringify(queue));
  },

  async clearQueue(): Promise<void> {
    await AsyncStorage.removeItem(KEYS.SYNC_QUEUE);
  }
};
```

### Network Status Detection
```typescript
// React Native
import NetInfo from '@react-native-community/netinfo';

NetInfo.addEventListener(state => {
  store.setIsOnline(state.isConnected);
});

// Web fallback
window.addEventListener('online', () => store.setIsOnline(true));
window.addEventListener('offline', () => store.setIsOnline(false));
```

### Queued Action Type
```typescript
interface QueuedAction {
  id: string;
  type: 'CREATE' | 'UPDATE' | 'DELETE' | 'ARCHIVE';
  payload: Partial<Entry>;
  timestamp: number;
  retries: number;
}
```

### Queue Processing
```typescript
async function processQueue() {
  const queue = await storage.getQueue();

  for (const action of queue) {
    try {
      switch (action.type) {
        case 'CREATE':
          await supabase.from('entries').insert(action.payload);
          break;
        case 'UPDATE':
          await supabase.from('entries').update(action.payload).eq('id', action.payload.id);
          break;
        case 'DELETE':
          await supabase.from('entries').delete().eq('id', action.payload.id);
          break;
      }
      // Remove from queue on success
    } catch (error) {
      // Increment retries, keep in queue
    }
  }
}
```

### File Locations
- Store: `lib/store.ts`
- New file: `lib/storage.ts`
- New file: `lib/sync.ts`
- Root layout: `app/_layout.tsx` (init sync listener)

### Dependencies to Add
```bash
bunx expo install @react-native-async-storage/async-storage
bunx expo install @react-native-community/netinfo
```

## Testing

### Manual Testing Required
- [ ] Turn off wifi → app still shows cached entries
- [ ] Create entry offline → appears in list
- [ ] Turn on wifi → entry syncs to server
- [ ] Check server → entry exists
- [ ] Edit while offline → changes sync when online
- [ ] Delete while offline → deletion syncs
- [ ] "Offline" indicator visible when disconnected
- [ ] "Syncing" indicator during sync

### Edge Cases
- [ ] Queue multiple actions offline → all sync correctly
- [ ] Kill app while offline → queue persists
- [ ] Conflict: edit same entry on two devices → last write wins

### Platforms to Test
- Web (primary) - localStorage
- iOS Expo Go - AsyncStorage
- Android Expo Go - AsyncStorage
- PWA - service worker + localStorage

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
