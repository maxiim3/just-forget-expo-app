# Story 2.1: Supabase Database Setup

## Status
Draft

## Story
**As a** developer,
**I want** to set up Supabase tables matching the existing Entry type,
**so that** the app can persist data to a real database.

## Acceptance Criteria

1. Tables created: `entries`, `labels`, `entry_labels`
2. Row Level Security (RLS) enabled on all tables
3. Entry type in `lib/supabase.ts` matches table schema
4. RLS policies ensure users only see their own data
5. Seed script available for test data
6. TypeScript types generated from Supabase schema

## Tasks / Subtasks

- [ ] Task 1: Create entries table (AC: 1, 3)
  - [ ] Define schema: id, user_id, content, raw_audio_url, created_at, updated_at, metadata (JSONB), archived
  - [ ] Set up primary key and indexes
  - [ ] Add foreign key to auth.users

- [ ] Task 2: Create labels table (AC: 1)
  - [ ] Define schema: id, user_id, name, type (space/tag/location/date), metadata
  - [ ] Set up indexes for common queries

- [ ] Task 3: Create entry_labels join table (AC: 1)
  - [ ] Define schema: entry_id, label_id
  - [ ] Set up composite primary key
  - [ ] Add foreign keys with CASCADE delete

- [ ] Task 4: Enable Row Level Security (AC: 2, 4)
  - [ ] Enable RLS on entries table
  - [ ] Enable RLS on labels table
  - [ ] Enable RLS on entry_labels table
  - [ ] Create policies: SELECT, INSERT, UPDATE, DELETE for authenticated users

- [ ] Task 5: Create RLS policies (AC: 4)
  - [ ] entries: user can only access own entries (user_id = auth.uid())
  - [ ] labels: user can only access own labels
  - [ ] entry_labels: user can only access joins for their entries

- [ ] Task 6: Update TypeScript types (AC: 3, 6)
  - [ ] Run `supabase gen types typescript` or update manually
  - [ ] Ensure Entry type matches table schema
  - [ ] Update `lib/supabase.ts` with generated types

- [ ] Task 7: Create seed script (AC: 5)
  - [ ] Create SQL seed file with sample entries
  - [ ] Include variety of content types
  - [ ] Document how to run seed

## Dev Notes

### Current Entry Type (lib/supabase.ts)
```typescript
export interface Entry {
  id: string;
  content: string;
  raw_audio_url?: string;
  created_at: string;
  updated_at: string;
  metadata?: Record<string, unknown>;
  archived: boolean;
}
```

### Supabase SQL for Tables
```sql
-- entries table
CREATE TABLE entries (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  content TEXT NOT NULL,
  raw_audio_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  metadata JSONB DEFAULT '{}',
  archived BOOLEAN DEFAULT FALSE
);

-- labels table
CREATE TABLE labels (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
  name TEXT NOT NULL,
  type TEXT CHECK (type IN ('space', 'tag', 'location', 'date')),
  metadata JSONB DEFAULT '{}'
);

-- entry_labels join table
CREATE TABLE entry_labels (
  entry_id UUID REFERENCES entries(id) ON DELETE CASCADE,
  label_id UUID REFERENCES labels(id) ON DELETE CASCADE,
  PRIMARY KEY (entry_id, label_id)
);
```

### RLS Policy Examples
```sql
-- Enable RLS
ALTER TABLE entries ENABLE ROW LEVEL SECURITY;

-- Policy for entries
CREATE POLICY "Users can view own entries"
  ON entries FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own entries"
  ON entries FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own entries"
  ON entries FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own entries"
  ON entries FOR DELETE
  USING (auth.uid() = user_id);
```

### File Locations
- Supabase types: `lib/supabase.ts`
- Mock data (to be replaced): `lib/mockData.ts`

### Supabase Dashboard
- Tables: Database → Tables
- RLS Policies: Authentication → Policies
- SQL Editor: SQL Editor (for running migrations)

## Testing

### Manual Testing Required
- [ ] Tables visible in Supabase Dashboard
- [ ] RLS enabled (green shield icon on tables)
- [ ] Insert test entry via SQL Editor
- [ ] Verify RLS blocks unauthorized access
- [ ] TypeScript types compile without errors
- [ ] Seed script populates test data

### Verification Queries
```sql
-- Check RLS is enabled
SELECT tablename, rowsecurity FROM pg_tables WHERE schemaname = 'public';

-- Test policy (as authenticated user)
SELECT * FROM entries; -- Should only return user's entries
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
