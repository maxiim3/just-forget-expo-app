# Story 4.3: Semantic Search

## Status
Draft

## Story
**As a** user,
**I want** to search entries by meaning, not just keywords,
**so that** I can find things without remembering exact words.

## Acceptance Criteria

1. Search input in Retrieve view
2. Query converted to embedding for similarity search
3. Hybrid search: vector + full-text combined
4. Results ranked by relevance
5. Search results display entry content and similarity score
6. Empty state for no results
7. Search performance < 2 seconds

## Tasks / Subtasks

- [ ] Task 1: Create search UI in Retrieve view (AC: 1, 6)
  - [ ] Add search input at top of view
  - [ ] Debounce input (300ms)
  - [ ] Show loading state during search
  - [ ] Display results as entry cards

- [ ] Task 2: Create semantic search Edge Function (AC: 2, 3)
  - [ ] Create `supabase/functions/semantic-search/index.ts`
  - [ ] Convert query to embedding
  - [ ] Call similarity search function
  - [ ] Combine with keyword search

- [ ] Task 3: Implement hybrid search (AC: 3, 4)
  - [ ] Vector similarity search (pgvector)
  - [ ] Full-text search (PostgreSQL tsvector)
  - [ ] Combine scores with weighting
  - [ ] Deduplicate results

- [ ] Task 4: Display search results (AC: 5)
  - [ ] Show entries matching query
  - [ ] Optional: show relevance indicator
  - [ ] Highlight matching text (optional)
  - [ ] Tap to open entry detail/edit

- [ ] Task 5: Optimize search performance (AC: 7)
  - [ ] Ensure indexes are used
  - [ ] Limit result count
  - [ ] Cache recent query embeddings
  - [ ] Monitor query times

- [ ] Task 6: Handle edge cases (AC: 6, 7)
  - [ ] Empty query → show all entries
  - [ ] No results → helpful message
  - [ ] Very long query → truncate for embedding
  - [ ] Search error → show error, allow retry

## Dev Notes

### Semantic Search Edge Function
```typescript
// supabase/functions/semantic-search/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import OpenAI from 'https://esm.sh/openai@4';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const openai = new OpenAI({ apiKey: Deno.env.get('OPENAI_API_KEY') });
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

serve(async (req) => {
  const { query, userId, limit = 20 } = await req.json();

  // Generate query embedding
  const embeddingResponse = await openai.embeddings.create({
    model: 'text-embedding-ada-002',
    input: query,
  });
  const queryEmbedding = embeddingResponse.data[0].embedding;

  // Semantic search
  const { data: semanticResults } = await supabase.rpc(
    'search_entries_by_similarity',
    {
      query_embedding: queryEmbedding,
      user_id_filter: userId,
      match_threshold: 0.5,
      match_count: limit
    }
  );

  // Full-text search
  const { data: textResults } = await supabase
    .from('entries')
    .select('id, content')
    .eq('user_id', userId)
    .eq('archived', false)
    .textSearch('content', query)
    .limit(limit);

  // Merge and deduplicate
  const combined = mergeResults(semanticResults, textResults);

  return new Response(JSON.stringify({ results: combined }));
});

function mergeResults(semantic: any[], text: any[]) {
  const seen = new Set();
  const merged = [];

  // Prioritize semantic results
  for (const r of semantic || []) {
    if (!seen.has(r.id)) {
      seen.add(r.id);
      merged.push({ ...r, source: 'semantic' });
    }
  }

  // Add text results not in semantic
  for (const r of text || []) {
    if (!seen.has(r.id)) {
      seen.add(r.id);
      merged.push({ ...r, similarity: 0.5, source: 'keyword' });
    }
  }

  return merged;
}
```

### Retrieve View Search UI
```tsx
// app/(tabs)/retrieve.tsx
function RetrieveScreen() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState<Entry[]>([]);
  const [isSearching, setIsSearching] = useState(false);
  const debouncedQuery = useDebounce(query, 300);

  useEffect(() => {
    if (debouncedQuery) {
      performSearch(debouncedQuery);
    } else {
      // Show all entries or recent entries
      loadRecentEntries();
    }
  }, [debouncedQuery]);

  async function performSearch(q: string) {
    setIsSearching(true);
    try {
      const { data } = await supabase.functions.invoke('semantic-search', {
        body: { query: q, userId: user.id }
      });
      setResults(data.results);
    } catch (error) {
      // Handle error
    } finally {
      setIsSearching(false);
    }
  }

  return (
    <SafeAreaView className="flex-1 bg-background">
      <View className="p-4">
        <TextInput
          className="border-2 border-muted rounded-sketch p-4 font-caveat text-lg"
          placeholder="Search your thoughts..."
          value={query}
          onChangeText={setQuery}
        />
      </View>

      {isSearching ? (
        <ActivityIndicator />
      ) : results.length > 0 ? (
        <FlatList
          data={results}
          renderItem={({ item }) => <SearchResultCard entry={item} />}
          keyExtractor={(item) => item.id}
        />
      ) : (
        <EmptyState message="No matching thoughts found" />
      )}
    </SafeAreaView>
  );
}
```

### Full-Text Search Setup
```sql
-- Add full-text search column
ALTER TABLE entries ADD COLUMN content_tsv tsvector
  GENERATED ALWAYS AS (to_tsvector('english', content)) STORED;

-- Create index for full-text search
CREATE INDEX entries_content_tsv_idx ON entries USING GIN (content_tsv);
```

### Search Result Card
```tsx
function SearchResultCard({ entry, similarity }: { entry: Entry; similarity?: number }) {
  return (
    <Pressable
      className="border-4 border-primary rounded-sketch p-4 mb-3 bg-surface"
      onPress={() => openEntry(entry)}
    >
      <Text className="font-caveat text-lg text-primary" numberOfLines={3}>
        {entry.content}
      </Text>
      {similarity && (
        <View className="flex-row items-center mt-2">
          <View
            className="h-1 bg-accent rounded"
            style={{ width: `${similarity * 100}%` }}
          />
          <Text className="font-caveat text-xs text-muted ml-2">
            {Math.round(similarity * 100)}% match
          </Text>
        </View>
      )}
    </Pressable>
  );
}
```

### File Locations
- Edge Function: `supabase/functions/semantic-search/index.ts`
- Retrieve view: `app/(tabs)/retrieve.tsx`
- Search result card: `components/retrieve/SearchResultCard.tsx`

### Performance Optimizations
- Cache query embeddings for repeated searches
- Limit results to 20-50 max
- Use database indexes effectively
- Consider adding pagination for large result sets

## Testing

### Manual Testing Required
- [ ] Type query → results appear
- [ ] Semantic match: "groceries" finds "buy milk and eggs"
- [ ] Keyword match: "milk" finds entries with "milk"
- [ ] No results → helpful empty state
- [ ] Tap result → opens entry detail
- [ ] Clear query → shows all/recent entries
- [ ] Search completes in < 2 seconds

### Search Quality Testing
- [ ] Synonym matching works (e.g., "car" finds "automobile")
- [ ] Concept matching works (e.g., "transportation" finds "car")
- [ ] Exact matches rank highest
- [ ] Irrelevant content not shown

### Edge Cases
- [ ] Very short query (1-2 chars) → keyword only
- [ ] Very long query → truncate, still works
- [ ] Special characters → handled
- [ ] Empty entries → skipped

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
