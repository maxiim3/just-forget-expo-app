# Story 4.2: Vector Embeddings

## Status
Draft

## Story
**As a** developer,
**I want** to generate and store vector embeddings for all entries,
**so that** semantic search can find entries by meaning, not just keywords.

## Acceptance Criteria

1. `embedding` column added to entries (vector type)
2. Embeddings generated for new entries on creation
3. Embeddings generated for existing entries (batch migration)
4. pgvector extension enabled in Supabase
5. Embedding dimension matches model (e.g., 1536 for OpenAI)
6. Embedding generation is async (non-blocking)
7. Fallback if embedding service unavailable

## Tasks / Subtasks

- [ ] Task 1: Enable pgvector extension (AC: 4)
  - [ ] Run `CREATE EXTENSION IF NOT EXISTS vector`
  - [ ] Verify extension is active
  - [ ] Check Supabase plan supports pgvector

- [ ] Task 2: Add embedding column to entries (AC: 1, 5)
  - [ ] Add column: `embedding vector(1536)`
  - [ ] Create index for similarity search
  - [ ] Update TypeScript types

- [ ] Task 3: Create embedding Edge Function (AC: 2)
  - [ ] Create `supabase/functions/generate-embedding/index.ts`
  - [ ] Call OpenAI embeddings API
  - [ ] Store embedding in entry row
  - [ ] Return success/failure status

- [ ] Task 4: Trigger embedding on entry creation (AC: 2, 6)
  - [ ] Call Edge Function after createEntry
  - [ ] Fire-and-forget pattern (async)
  - [ ] Entry usable without embedding

- [ ] Task 5: Update embedding on entry edit (AC: 2)
  - [ ] Regenerate embedding when content changes
  - [ ] Could trigger on database UPDATE or from client
  - [ ] Debounce if rapid edits

- [ ] Task 6: Batch migrate existing entries (AC: 3)
  - [ ] Create migration script/function
  - [ ] Process entries without embeddings
  - [ ] Rate limit to avoid API throttling
  - [ ] Log progress and errors

- [ ] Task 7: Create similarity search function (AC: 1)
  - [ ] Create SQL function for cosine similarity
  - [ ] Or use pgvector's `<->` operator
  - [ ] Test with sample queries

- [ ] Task 8: Handle embedding failures (AC: 7)
  - [ ] Log errors for debugging
  - [ ] Entry remains functional
  - [ ] Retry mechanism (optional)
  - [ ] Mark entries without embeddings

## Dev Notes

### Enable pgvector
```sql
-- Enable extension
CREATE EXTENSION IF NOT EXISTS vector;

-- Add embedding column
ALTER TABLE entries
ADD COLUMN embedding vector(1536);

-- Create index for fast similarity search
CREATE INDEX entries_embedding_idx
  ON entries
  USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);
```

### Generate Embedding Edge Function
```typescript
// supabase/functions/generate-embedding/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import OpenAI from 'https://esm.sh/openai@4';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const openai = new OpenAI({ apiKey: Deno.env.get('OPENAI_API_KEY') });
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

serve(async (req) => {
  const { entryId, content } = await req.json();

  // Generate embedding
  const response = await openai.embeddings.create({
    model: 'text-embedding-ada-002',
    input: content,
  });

  const embedding = response.data[0].embedding;

  // Store in database
  const { error } = await supabase
    .from('entries')
    .update({ embedding })
    .eq('id', entryId);

  if (error) throw error;

  return new Response(JSON.stringify({ success: true }));
});
```

### Similarity Search SQL Function
```sql
-- Create search function
CREATE OR REPLACE FUNCTION search_entries_by_similarity(
  query_embedding vector(1536),
  user_id_filter uuid,
  match_threshold float DEFAULT 0.7,
  match_count int DEFAULT 10
)
RETURNS TABLE (
  id uuid,
  content text,
  similarity float
)
LANGUAGE plpgsql
AS $$
BEGIN
  RETURN QUERY
  SELECT
    entries.id,
    entries.content,
    1 - (entries.embedding <=> query_embedding) AS similarity
  FROM entries
  WHERE
    entries.user_id = user_id_filter
    AND entries.archived = false
    AND entries.embedding IS NOT NULL
    AND 1 - (entries.embedding <=> query_embedding) > match_threshold
  ORDER BY entries.embedding <=> query_embedding
  LIMIT match_count;
END;
$$;
```

### Batch Migration Script
```typescript
// Run as one-time script or scheduled job
async function migrateEmbeddings() {
  const batchSize = 50;
  let offset = 0;
  let processed = 0;

  while (true) {
    const { data: entries } = await supabase
      .from('entries')
      .select('id, content')
      .is('embedding', null)
      .range(offset, offset + batchSize - 1);

    if (!entries?.length) break;

    for (const entry of entries) {
      await supabase.functions.invoke('generate-embedding', {
        body: { entryId: entry.id, content: entry.content }
      });
      processed++;

      // Rate limit: 50 requests per minute for OpenAI
      await new Promise(r => setTimeout(r, 1200));
    }

    offset += batchSize;
    console.log(`Processed ${processed} entries`);
  }
}
```

### TypeScript Type Update
```typescript
interface Entry {
  id: string;
  content: string;
  // ... other fields
  embedding?: number[]; // 1536-dimensional vector
}
```

### File Locations
- Edge Function: `supabase/functions/generate-embedding/index.ts`
- Migration: `supabase/migrations/add_embedding_column.sql`
- Search function: `supabase/migrations/add_similarity_search.sql`

### Cost Estimation (OpenAI Embeddings)
- text-embedding-ada-002: $0.0001 per 1K tokens
- Average entry ~50 tokens: $0.000005 per entry
- 1000 entries: $0.005
- Very cost-effective!

## Testing

### Manual Testing Required
- [ ] Create entry → embedding generated
- [ ] Check database → embedding column populated
- [ ] Edit entry → embedding updated
- [ ] Run batch migration → old entries get embeddings
- [ ] Similarity search returns relevant results
- [ ] Entries without embeddings → still usable

### Embedding Quality Testing
- [ ] Similar content → similar embeddings (cosine sim > 0.8)
- [ ] Different content → different embeddings
- [ ] Short vs long content → both work

### Performance Testing
- [ ] Search with 1000 entries → fast response
- [ ] Index being used → check query plan
- [ ] Batch migration → completes without timeout

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
