# Story 1.2: Unified Command Input

## Status
Draft

## Story
**As a** user interacting with my thoughts,
**I want** a unified command input at the bottom of the screen,
**so that** I can add, search, filter, and act on entries using natural commands without switching views.

## Acceptance Criteria

1. Command Input is fixed at the bottom, visible on both Swipe and Grid views
2. Default mode is `add` — typing without keywords creates a new entry
3. Keywords (`add`, `search`, `find`, `filter`, `archive`, `delete`) are detected and highlighted
4. Tags (`#tag`) are detected and displayed in green
5. Natural dates (`tomorrow`, `monday`, `next week`) are detected and displayed in blue
6. A command chip appears above the input showing the detected action
7. Search/filter commands update the visible entries in real-time (debounced 150ms)
8. Action commands (`archive`, `delete`) operate on selected entries with confirmation
9. Voice button placeholder is visible (disabled, shows "Coming soon" on tap)
10. Retrieve tab is removed — navigation is 2 views only (Swipe, Grid)
11. Tab bar is hidden — views switch via horizontal swipe or command (`swipe`, `grid`)

## Tasks / Subtasks

- [ ] Task 1: Create command types and parser (AC: 3, 4, 5)
  - [ ] Create `lib/commandTypes.ts` with ParsedCommand, Token interfaces
  - [ ] Create `lib/commandParser.ts` with tokenize() and parseCommand() functions
  - [ ] Define keyword patterns (COMMAND_KEYWORDS map)
  - [ ] Define date patterns (DATE_PATTERNS array with resolvers)
  - [ ] Define tag pattern (/#\w+/g)

- [ ] Task 2: Create HighlightedTextInput component (AC: 3, 4, 5)
  - [ ] Create `components/command/HighlightedTextInput.tsx`
  - [ ] Implement overlay technique (transparent TextInput + colored Text overlay)
  - [ ] Map token types to colors (command: accent, tag: green, date: blue, text: primary)
  - [ ] Ensure cursor remains visible and functional

- [ ] Task 3: Create CommandChip component (AC: 6)
  - [ ] Create `components/command/CommandChip.tsx`
  - [ ] Display detected command type as label ("Adding...", "Searching...", etc.)
  - [ ] Show tag badges for detected tags
  - [ ] Add dismiss button to clear command
  - [ ] Animate enter/exit with FadeIn/FadeOut

- [ ] Task 4: Create VoiceButton placeholder (AC: 9)
  - [ ] Create `components/command/VoiceButton.tsx`
  - [ ] Render mic icon button
  - [ ] Show "Coming soon" toast/alert on press
  - [ ] Style consistent with input bar

- [ ] Task 5: Create CommandInput main component (AC: 1, 2, 6)
  - [ ] Create `components/command/CommandInput.tsx`
  - [ ] Compose HighlightedTextInput, CommandChip, VoiceButton
  - [ ] Position fixed at bottom with SafeAreaView padding
  - [ ] Handle submit action based on parsed command
  - [ ] Wire to store for add, archive, delete actions

- [ ] Task 6: Add command state to store (AC: 7, 8)
  - [ ] Add `commandInput: string` and `setCommandInput` to store
  - [ ] Add `activeFilter: FilterState` with query, tags, showArchived
  - [ ] Add `setActiveFilter` and `clearFilter` actions
  - [ ] Create `useFilteredEntries()` selector hook

- [ ] Task 7: Integrate into views (AC: 1, 7, 10)
  - [ ] Import and render CommandInput in both Swipe and Grid views
  - [ ] Replace entries with filteredEntries in both views
  - [ ] Add bottom padding to content to account for input height
  - [ ] Test filter updates views correctly

- [ ] Task 8: Migrate navigation (AC: 10, 11)
  - [ ] Rename `capture.tsx` to `swipe.tsx`
  - [ ] Delete `retrieve.tsx`
  - [ ] Update `_layout.tsx` to hide tab bar
  - [ ] Add horizontal swipe gesture between views (optional: via command)

- [ ] Task 9: Delete deprecated components
  - [ ] Remove `components/capture/BottomDrawer.tsx`
  - [ ] Remove BottomDrawer usage from swipe.tsx
  - [ ] Clean up any unused imports

## Dev Notes

### Architecture

**Component Structure:**
```
components/command/
  CommandInput.tsx       <- Main wrapper
  CommandParser.ts       <- Pure parsing functions
  CommandChip.tsx        <- Detected command display
  HighlightedTextInput.tsx <- Rich text overlay
  VoiceButton.tsx        <- Placeholder for voice
  index.ts               <- Barrel export
```

**State Flow:**
```
User types → CommandParser.tokenize() → HighlightedTextInput renders colored tokens
           → CommandParser.parseCommand() → CommandChip shows detected action
           → On submit → executeCommand() dispatches to store
           → Search/filter → setActiveFilter() → views re-render filtered entries
```

### Highlighting Technique

React Native TextInput doesn't support rich text. Solution:
1. TextInput with `color: 'transparent'` (or matching background)
2. Absolutely positioned overlay View with same dimensions
3. Overlay contains Text with colored spans for each token
4. Overlay has `pointerEvents="none"` so touches go to TextInput

### Token Colors (from theme)
- **Command** (`add`, `search`...): `#FF6B6B` (accent)
- **Tag** (`#tag`): `#16A34A` (success green)
- **Date** (`tomorrow`): `#3B82F6` (blue)
- **Text**: `#2D2D2D` (primary)

### Store Integration
```typescript
// New state in store.ts
interface CommandState {
  commandInput: string;
  setCommandInput: (input: string) => void;
  activeFilter: {
    query: string;
    tags: string[];
    showArchived: boolean;
  };
  setActiveFilter: (filter: Partial<FilterState>) => void;
  clearFilter: () => void;
}
```

### File Locations
- Command components: `components/command/`
- Parser: `lib/commandParser.ts`
- Types: `lib/commandTypes.ts`
- Store: `lib/store.ts`
- Views: `app/(tabs)/swipe.tsx`, `app/(tabs)/grid.tsx`
- Layout: `app/(tabs)/_layout.tsx`

### Components to Delete
- `components/capture/BottomDrawer.tsx` — replaced by CommandInput
- `app/(tabs)/retrieve.tsx` — functionality merged into CommandInput

## Testing

### Manual Testing Required
- [ ] Type without keyword → chip shows "Adding..."
- [ ] Type "search groceries" → chip shows "Searching...", entries filter
- [ ] Type "#work" → tag highlighted green, chip shows tag badge
- [ ] Type "tomorrow" → date highlighted blue
- [ ] Press Enter with "add Buy milk" → new entry created
- [ ] Press Enter with "archive" → confirmation, selected entries archived
- [ ] Tap voice button → shows "Coming soon" toast
- [ ] Switch between Swipe and Grid → input remains visible
- [ ] Filter persists across view switches
- [ ] Clear filter → all entries visible again

### Platforms to Test
- Web (primary)
- iOS Simulator / Expo Go
- Android Emulator / Expo Go

### Edge Cases
- [ ] Empty input → no command chip
- [ ] Multiple tags → all highlighted, all in chip
- [ ] Invalid date text → not highlighted
- [ ] Very long input → proper wrapping/scrolling
- [ ] Keyboard dismiss → input stays visible

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-08 | 0.1 | Initial draft as "CRUD Retrieve View" | Bob (SM) |
| 2026-01-12 | 0.2 | Rewritten as "Unified Command Input" | Claude (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
