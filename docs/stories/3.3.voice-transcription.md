# Story 3.3: Voice Transcription

## Status
Draft

## Story
**As a** user,
**I want** my voice notes automatically transcribed,
**so that** I can search and read them later.

## Acceptance Criteria

1. Audio sent to transcription service after upload
2. Transcription stored in entry `content` field
3. Processing indicator while transcribing
4. Fallback if transcription fails (keep audio, show error)
5. Original audio preserved for playback
6. Transcription editable by user
7. Search includes transcribed content

## Tasks / Subtasks

- [ ] Task 1: Choose and set up transcription service (AC: 1)
  - [ ] Evaluate options: OpenAI Whisper, Google Speech-to-Text, AssemblyAI
  - [ ] Set up API credentials
  - [ ] Store API key in Supabase secrets (for Edge Function)

- [ ] Task 2: Create Supabase Edge Function for transcription (AC: 1, 2)
  - [ ] Create `supabase/functions/transcribe/index.ts`
  - [ ] Accept audio URL or file
  - [ ] Call transcription API
  - [ ] Return transcription text

- [ ] Task 3: Trigger transcription after upload (AC: 1)
  - [ ] Call Edge Function after audio upload
  - [ ] Pass audio URL to function
  - [ ] Handle async nature (don't block UI)

- [ ] Task 4: Update entry with transcription (AC: 2)
  - [ ] Receive transcription result
  - [ ] Update entry `content` field
  - [ ] Keep `raw_audio_url` intact

- [ ] Task 5: Show processing indicator (AC: 3)
  - [ ] Add `transcription_status` field to entry (pending/complete/failed)
  - [ ] Show spinner/indicator on entry card
  - [ ] Update UI when transcription complete

- [ ] Task 6: Handle transcription failures (AC: 4)
  - [ ] Catch transcription errors
  - [ ] Set status to 'failed'
  - [ ] Show error message on entry
  - [ ] Allow retry

- [ ] Task 7: Enable transcription editing (AC: 6)
  - [ ] Pre-fill EditModal with transcription
  - [ ] User can correct transcription
  - [ ] Save edited transcription

- [ ] Task 8: Ensure search includes transcriptions (AC: 7)
  - [ ] Verify content field is searchable
  - [ ] Test search with transcribed text
  - [ ] Index transcriptions for future semantic search

## Dev Notes

### Transcription Service Options

| Service | Pros | Cons |
|---------|------|------|
| **OpenAI Whisper** | High accuracy, good for many languages | Cost per minute |
| **Google Speech-to-Text** | Good accuracy, streaming support | Complex setup |
| **AssemblyAI** | Easy API, good features | Cost |
| **Deepgram** | Fast, real-time capable | Cost |

**Recommendation:** Start with OpenAI Whisper for accuracy and simplicity.

### Supabase Edge Function
```typescript
// supabase/functions/transcribe/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import OpenAI from 'https://esm.sh/openai@4';

const openai = new OpenAI({
  apiKey: Deno.env.get('OPENAI_API_KEY'),
});

serve(async (req) => {
  const { audioUrl } = await req.json();

  // Download audio file
  const audioResponse = await fetch(audioUrl);
  const audioBlob = await audioResponse.blob();

  // Transcribe with Whisper
  const transcription = await openai.audio.transcriptions.create({
    file: audioBlob,
    model: 'whisper-1',
  });

  return new Response(
    JSON.stringify({ text: transcription.text }),
    { headers: { 'Content-Type': 'application/json' } }
  );
});
```

### Entry Schema Update
```typescript
interface Entry {
  id: string;
  content: string;
  raw_audio_url?: string;
  transcription_status?: 'pending' | 'complete' | 'failed';
  // ... other fields
}
```

### Client-Side Flow
```typescript
async function createVoiceEntry(audioUrl: string) {
  // 1. Create entry with pending status
  const entry = await createEntry({
    content: '[Transcribing...]',
    raw_audio_url: audioUrl,
    transcription_status: 'pending'
  });

  // 2. Trigger transcription (async)
  transcribeAudio(entry.id, audioUrl);

  return entry;
}

async function transcribeAudio(entryId: string, audioUrl: string) {
  try {
    const { data } = await supabase.functions.invoke('transcribe', {
      body: { audioUrl }
    });

    await updateEntry(entryId, {
      content: data.text,
      transcription_status: 'complete'
    });
  } catch (error) {
    await updateEntry(entryId, {
      content: '[Transcription failed]',
      transcription_status: 'failed'
    });
  }
}
```

### File Locations
- Edge Function: `supabase/functions/transcribe/index.ts`
- Store: `lib/store.ts`
- Entry type: `lib/supabase.ts`

### Cost Estimation (Whisper)
- ~$0.006 per minute of audio
- 15-second note ≈ $0.0015 per note
- 100 notes/day ≈ $0.15/day ≈ $4.50/month

## Testing

### Manual Testing Required
- [ ] Record voice note → "Transcribing..." shown
- [ ] Wait for transcription → content updated
- [ ] Transcription matches spoken words
- [ ] Search for transcribed word → entry found
- [ ] Edit transcription → changes saved
- [ ] Transcription fails → error shown, audio preserved
- [ ] Retry transcription → works after fix

### Edge Cases
- [ ] Very quiet audio → partial transcription
- [ ] Non-English audio → test language support
- [ ] Network error during transcription → retry works
- [ ] Long audio (15s) → full transcription

### Platforms to Test
- Web (primary)
- iOS Expo Go
- Android Expo Go

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
