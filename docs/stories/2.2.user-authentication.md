# Story 2.2: User Authentication

## Status
Draft

## Story
**As a** user,
**I want** to sign in with magic link or Google,
**so that** my entries are private and synced across devices.

## Acceptance Criteria

1. Magic link auth flow works (email → click link → signed in)
2. Google OAuth works
3. Session persists across app restarts
4. Unauthenticated users see sign-in screen
5. User ID attached to all entries (RLS enforced)
6. Sign out functionality available
7. Auth state reflected in Zustand store

## Tasks / Subtasks

- [ ] Task 1: Configure Supabase Auth providers (AC: 1, 2)
  - [ ] Enable Email provider in Supabase Dashboard
  - [ ] Configure magic link settings (expiry, redirect URL)
  - [ ] Enable Google OAuth provider
  - [ ] Set up OAuth redirect URLs for Expo

- [ ] Task 2: Create auth context/hook (AC: 3, 7)
  - [ ] Create `lib/auth.ts` with auth utilities
  - [ ] Set up `onAuthStateChange` listener
  - [ ] Store session in Zustand store
  - [ ] Handle session refresh

- [ ] Task 3: Create sign-in screen (AC: 1, 2, 4)
  - [ ] Create `app/auth/sign-in.tsx` screen
  - [ ] Add email input for magic link
  - [ ] Add "Sign in with Google" button
  - [ ] Style consistent with app design (sketch aesthetic)

- [ ] Task 4: Implement magic link flow (AC: 1)
  - [ ] Call `supabase.auth.signInWithOtp({ email })`
  - [ ] Show "Check your email" confirmation
  - [ ] Handle deep link callback
  - [ ] Configure expo-linking for auth redirects

- [ ] Task 5: Implement Google OAuth (AC: 2)
  - [ ] Call `supabase.auth.signInWithOAuth({ provider: 'google' })`
  - [ ] Handle OAuth redirect
  - [ ] Extract and store session

- [ ] Task 6: Persist session (AC: 3)
  - [ ] Use expo-secure-store for token storage
  - [ ] Auto-restore session on app launch
  - [ ] Handle session expiry gracefully

- [ ] Task 7: Protect routes (AC: 4)
  - [ ] Create auth guard in root layout
  - [ ] Redirect unauthenticated users to sign-in
  - [ ] Allow authenticated users to access tabs

- [ ] Task 8: Add sign out (AC: 6)
  - [ ] Create sign-out button in settings/profile
  - [ ] Call `supabase.auth.signOut()`
  - [ ] Clear Zustand store on logout
  - [ ] Redirect to sign-in screen

## Dev Notes

### Supabase Auth Methods
```typescript
// Magic link
const { error } = await supabase.auth.signInWithOtp({
  email: 'user@example.com',
  options: {
    emailRedirectTo: 'exp://localhost:8081/auth/callback'
  }
});

// Google OAuth
const { error } = await supabase.auth.signInWithOAuth({
  provider: 'google',
  options: {
    redirectTo: 'exp://localhost:8081/auth/callback'
  }
});

// Sign out
await supabase.auth.signOut();

// Get current user
const { data: { user } } = await supabase.auth.getUser();
```

### Session Listener
```typescript
supabase.auth.onAuthStateChange((event, session) => {
  if (event === 'SIGNED_IN') {
    // Update store with user
  } else if (event === 'SIGNED_OUT') {
    // Clear store
  }
});
```

### File Locations
- Supabase client: `lib/supabase.ts`
- Store: `lib/store.ts`
- Root layout: `app/_layout.tsx`
- New files: `app/auth/sign-in.tsx`, `lib/auth.ts`

### Expo Deep Linking
- Configure in `app.json` under `expo.scheme`
- Handle in `app/auth/callback.tsx` or root layout

### Store Updates Needed
```typescript
// Add to useAppStore
user: User | null;
setUser: (user: User | null) => void;
isAuthenticated: boolean;
```

## Testing

### Manual Testing Required
- [ ] Enter email → receive magic link email
- [ ] Click magic link → app opens and signed in
- [ ] Tap Google sign-in → OAuth flow → signed in
- [ ] Close and reopen app → still signed in
- [ ] Sign out → redirected to sign-in screen
- [ ] Try to access tabs without auth → blocked

### Platforms to Test
- Web (primary) - magic link and Google
- iOS Expo Go - deep linking
- Android Expo Go - deep linking

### Test Accounts
- Create test accounts in Supabase Dashboard
- Use `+` email trick for multiple accounts (test+1@example.com)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
