# Story 2.3: Entry CRUD with Supabase

## Status
Draft

## Story
**As a** user,
**I want** to create, read, update, and delete entries that persist to the cloud,
**so that** my data is saved and available across devices.

## Acceptance Criteria

1. Create entry → inserts to Supabase
2. Read entries → fetches from Supabase (with local cache)
3. Update entry → updates in Supabase
4. Delete entry → removes from Supabase
5. Archive entry → sets archived flag in Supabase
6. Real-time subscription updates local state
7. Optimistic updates for responsive UI
8. Loading and error states handled gracefully

## Tasks / Subtasks

- [ ] Task 1: Create Supabase query functions (AC: 1, 2, 3, 4, 5)
  - [ ] Create `lib/api/entries.ts` with CRUD functions
  - [ ] `fetchEntries()` - get all user entries
  - [ ] `createEntry(content)` - insert new entry
  - [ ] `updateEntry(id, updates)` - update entry
  - [ ] `deleteEntry(id)` - hard delete entry
  - [ ] `archiveEntry(id)` - set archived = true

- [ ] Task 2: Update Zustand store with async actions (AC: 1, 2, 3, 4, 5, 7)
  - [ ] Add `fetchEntries` async action
  - [ ] Modify `addEntry` to call Supabase
  - [ ] Modify `updateEntry` to call Supabase
  - [ ] Modify `deleteEntry` to call Supabase
  - [ ] Modify `archiveEntry` to call Supabase
  - [ ] Implement optimistic updates pattern

- [ ] Task 3: Add loading and error states (AC: 8)
  - [ ] Add `isLoading` state to store
  - [ ] Add `error` state to store
  - [ ] Show loading indicator during fetch
  - [ ] Show error toast/message on failure
  - [ ] Retry logic for transient errors

- [ ] Task 4: Remove mock data (AC: 2)
  - [ ] Delete or deprecate `lib/mockData.ts`
  - [ ] Update initial store state to empty array
  - [ ] Fetch real data on app launch

- [ ] Task 5: Implement real-time subscription (AC: 6)
  - [ ] Subscribe to entries table changes
  - [ ] Handle INSERT, UPDATE, DELETE events
  - [ ] Update local store on remote changes
  - [ ] Unsubscribe on unmount/logout

- [ ] Task 6: Integrate with existing views (AC: 1-5)
  - [ ] Update Capture view to use new store actions
  - [ ] Update Grid view to use new store actions
  - [ ] Update Retrieve view to use new store actions
  - [ ] Ensure EditModal works with Supabase

- [ ] Task 7: Handle user context (AC: 1)
  - [ ] Ensure user_id is set on create
  - [ ] Filter queries by authenticated user
  - [ ] Handle unauthenticated state

## Dev Notes

### Supabase Query Examples
```typescript
// Fetch entries
const { data, error } = await supabase
  .from('entries')
  .select('*')
  .order('created_at', { ascending: false });

// Create entry
const { data, error } = await supabase
  .from('entries')
  .insert({ content, user_id: user.id })
  .select()
  .single();

// Update entry
const { data, error } = await supabase
  .from('entries')
  .update({ content, updated_at: new Date().toISOString() })
  .eq('id', entryId)
  .select()
  .single();

// Delete entry
const { error } = await supabase
  .from('entries')
  .delete()
  .eq('id', entryId);

// Archive entry
const { data, error } = await supabase
  .from('entries')
  .update({ archived: true })
  .eq('id', entryId)
  .select()
  .single();
```

### Real-time Subscription
```typescript
const subscription = supabase
  .channel('entries')
  .on('postgres_changes',
    { event: '*', schema: 'public', table: 'entries' },
    (payload) => {
      if (payload.eventType === 'INSERT') {
        // Add to store
      } else if (payload.eventType === 'UPDATE') {
        // Update in store
      } else if (payload.eventType === 'DELETE') {
        // Remove from store
      }
    }
  )
  .subscribe();
```

### Optimistic Update Pattern
```typescript
// Example for createEntry
createEntry: async (content) => {
  const tempId = `temp-${Date.now()}`;
  const optimisticEntry = { id: tempId, content, ... };

  // 1. Optimistic update
  set((state) => ({ entries: [optimisticEntry, ...state.entries] }));

  // 2. Server request
  const { data, error } = await supabase.from('entries').insert(...);

  if (error) {
    // 3a. Rollback on error
    set((state) => ({ entries: state.entries.filter(e => e.id !== tempId) }));
  } else {
    // 3b. Replace temp with real
    set((state) => ({
      entries: state.entries.map(e => e.id === tempId ? data : e)
    }));
  }
}
```

### File Locations
- Store: `lib/store.ts`
- Supabase client: `lib/supabase.ts`
- Mock data (remove): `lib/mockData.ts`
- New file: `lib/api/entries.ts`

### Store Methods to Update
- `addEntry` → async with Supabase insert
- `updateEntry` → async with Supabase update
- `deleteEntry` → async with Supabase delete
- `archiveEntry` → async with Supabase update
- New: `fetchEntries` → initial data load

## Testing

### Manual Testing Required
- [ ] Create entry → appears in Grid view
- [ ] Close app → reopen → entry still there
- [ ] Edit entry → changes persist after refresh
- [ ] Delete entry → removed permanently
- [ ] Archive entry → moves to archived section
- [ ] Open on another device → same entries visible
- [ ] Offline: show appropriate message (for now)

### Error Scenarios
- [ ] Network error → shows error, allows retry
- [ ] Invalid data → shows validation error
- [ ] Concurrent edit → last write wins

### Platforms to Test
- Web (primary)
- iOS Expo Go
- Android Expo Go

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
