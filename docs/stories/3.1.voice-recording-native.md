# Story 3.1: Voice Recording (Native)

## Status
Draft

## Story
**As a** mobile user,
**I want** to tap a microphone button and record a voice note,
**so that** I can capture thoughts without typing.

## Acceptance Criteria

1. Mic button visible in BottomDrawer
2. Tap to start recording, tap to stop
3. Recording limited to 15 seconds (auto-stop)
4. Audio saved to Supabase Storage
5. Entry created with `raw_audio_url` populated
6. Visual timer during recording
7. Recording indicator (pulsing icon)
8. Text input still works normally

## Tasks / Subtasks

- [ ] Task 1: Install expo-av (AC: all)
  - [ ] Run `bunx expo install expo-av`
  - [ ] Configure permissions in app.json
  - [ ] Verify installation

- [ ] Task 2: Create VoiceRecorder component (AC: 1, 6, 7)
  - [ ] Create `components/capture/VoiceRecorder.tsx`
  - [ ] Mic button with recording state
  - [ ] Timer display (00:00 format)
  - [ ] Pulsing animation during recording

- [ ] Task 3: Implement recording logic (AC: 2, 3)
  - [ ] Request microphone permission
  - [ ] Start recording with expo-av Audio.Recording
  - [ ] Stop recording on tap or 15s timeout
  - [ ] Handle recording errors gracefully

- [ ] Task 4: Configure audio settings (AC: 2)
  - [ ] Set audio quality (medium for balance)
  - [ ] Set format (m4a for cross-platform)
  - [ ] Configure recording options

- [ ] Task 5: Upload to Supabase Storage (AC: 4)
  - [ ] Create 'audio' bucket in Supabase (if not exists)
  - [ ] Upload recording file after stop
  - [ ] Generate public URL or signed URL
  - [ ] Handle upload errors

- [ ] Task 6: Create entry with audio (AC: 5)
  - [ ] Call `addEntry` with `raw_audio_url`
  - [ ] Set content to "[Voice note]" placeholder
  - [ ] Entry appears in stack after recording

- [ ] Task 7: Integrate with BottomDrawer (AC: 1, 8)
  - [ ] Add mic button next to text input
  - [ ] Toggle between text and voice modes
  - [ ] Disable text input during recording
  - [ ] Keep existing text input functionality

- [ ] Task 8: Add audio playback (AC: 5)
  - [ ] Play button on entries with audio
  - [ ] Simple playback controls
  - [ ] Stop playback when navigating away

## Dev Notes

### expo-av Recording Setup
```typescript
import { Audio } from 'expo-av';

// Request permission
const { granted } = await Audio.requestPermissionsAsync();

// Configure audio mode
await Audio.setAudioModeAsync({
  allowsRecordingIOS: true,
  playsInSilentModeIOS: true,
});

// Start recording
const recording = new Audio.Recording();
await recording.prepareToRecordAsync(
  Audio.RecordingOptionsPresets.HIGH_QUALITY
);
await recording.startAsync();

// Stop and get URI
await recording.stopAndUnloadAsync();
const uri = recording.getURI();
```

### Supabase Storage Upload
```typescript
const fileName = `${user.id}/${Date.now()}.m4a`;

const { data, error } = await supabase.storage
  .from('audio')
  .upload(fileName, audioBlob, {
    contentType: 'audio/m4a',
    upsert: false
  });

// Get public URL
const { data: { publicUrl } } = supabase.storage
  .from('audio')
  .getPublicUrl(fileName);
```

### Recording Options
```typescript
const RECORDING_OPTIONS = {
  android: {
    extension: '.m4a',
    outputFormat: Audio.AndroidOutputFormat.MPEG_4,
    audioEncoder: Audio.AndroidAudioEncoder.AAC,
    sampleRate: 44100,
    numberOfChannels: 2,
    bitRate: 128000,
  },
  ios: {
    extension: '.m4a',
    audioQuality: Audio.IOSAudioQuality.MEDIUM,
    sampleRate: 44100,
    numberOfChannels: 2,
    bitRate: 128000,
    linearPCMBitDepth: 16,
    linearPCMIsBigEndian: false,
    linearPCMIsFloat: false,
  },
};
```

### File Locations
- BottomDrawer: `components/capture/BottomDrawer.tsx`
- New file: `components/capture/VoiceRecorder.tsx`
- Store: `lib/store.ts`

### Permissions (app.json)
```json
{
  "expo": {
    "plugins": [
      [
        "expo-av",
        {
          "microphonePermission": "Allow Forget to access your microphone for voice notes."
        }
      ]
    ]
  }
}
```

### UI Design Notes
- Mic icon: Use existing icon library or add new
- Timer: `font-mono` or `font-caveat` for sketch feel
- Recording state: Red pulsing indicator
- Button style: Same as existing FAB pattern

## Testing

### Manual Testing Required
- [ ] Tap mic → permission prompt (first time)
- [ ] Grant permission → recording starts
- [ ] Timer counts up to 15 seconds
- [ ] Recording auto-stops at 15 seconds
- [ ] Tap to stop before 15 seconds
- [ ] Entry created with audio
- [ ] Audio plays back correctly
- [ ] Text input still works
- [ ] Error shown if permission denied

### Edge Cases
- [ ] Permission denied → show helpful message
- [ ] Recording interrupted (call, etc.) → handle gracefully
- [ ] Storage full → show error
- [ ] Network error on upload → retry or queue

### Platforms to Test
- iOS Expo Go
- Android Expo Go
- (Web handled in Story 3.2)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
