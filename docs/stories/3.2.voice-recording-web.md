# Story 3.2: Voice Recording (Web)

## Status
Draft

## Story
**As a** web/PWA user,
**I want** to record voice notes in the browser,
**so that** I have feature parity with mobile.

## Acceptance Criteria

1. MediaRecorder API used for web platform
2. Browser permission prompt for microphone
3. Same 15-second limit as native
4. Audio uploaded to Supabase Storage
5. Fallback message if browser unsupported
6. Same UI as native (VoiceRecorder component)
7. PWA still installable after adding this feature

## Tasks / Subtasks

- [ ] Task 1: Detect platform for recorder selection (AC: 1, 6)
  - [ ] Use `Platform.OS` from react-native
  - [ ] Create `useVoiceRecorder` hook with platform detection
  - [ ] Abstract recording interface for both platforms

- [ ] Task 2: Implement web recording with MediaRecorder (AC: 1)
  - [ ] Request microphone via `navigator.mediaDevices.getUserMedia`
  - [ ] Create MediaRecorder instance
  - [ ] Handle `dataavailable` event to collect chunks
  - [ ] Stop and create Blob from chunks

- [ ] Task 3: Handle browser permissions (AC: 2)
  - [ ] Check permission state before recording
  - [ ] Show permission request UI
  - [ ] Handle denied permission gracefully
  - [ ] Remember permission state

- [ ] Task 4: Implement 15-second limit (AC: 3)
  - [ ] Start timer on recording start
  - [ ] Auto-stop at 15 seconds
  - [ ] Share timer logic with native implementation

- [ ] Task 5: Upload web audio to Supabase (AC: 4)
  - [ ] Convert Blob to appropriate format
  - [ ] Upload to Supabase Storage
  - [ ] Handle CORS if needed
  - [ ] Generate URL for entry

- [ ] Task 6: Create browser support check (AC: 5)
  - [ ] Check for MediaRecorder support
  - [ ] Check for getUserMedia support
  - [ ] Show fallback message if unsupported
  - [ ] List supported browsers in message

- [ ] Task 7: Ensure PWA compatibility (AC: 7)
  - [ ] Test PWA installation after changes
  - [ ] Verify service worker still works
  - [ ] Test offline behavior (graceful degradation)

## Dev Notes

### MediaRecorder API
```typescript
// Check support
const isSupported = 'MediaRecorder' in window &&
  navigator.mediaDevices?.getUserMedia;

// Request permission and start
const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
const mediaRecorder = new MediaRecorder(stream, {
  mimeType: 'audio/webm;codecs=opus'
});

const chunks: Blob[] = [];
mediaRecorder.ondataavailable = (e) => chunks.push(e.data);

mediaRecorder.onstop = () => {
  const blob = new Blob(chunks, { type: 'audio/webm' });
  // Upload blob to Supabase
};

// Start/stop
mediaRecorder.start();
setTimeout(() => mediaRecorder.stop(), 15000); // 15 sec limit
```

### Platform Detection Hook
```typescript
// hooks/useVoiceRecorder.ts
import { Platform } from 'react-native';
import { useNativeRecorder } from './useNativeRecorder';
import { useWebRecorder } from './useWebRecorder';

export function useVoiceRecorder() {
  if (Platform.OS === 'web') {
    return useWebRecorder();
  }
  return useNativeRecorder();
}

// Common interface
interface VoiceRecorder {
  isRecording: boolean;
  duration: number;
  isSupported: boolean;
  startRecording: () => Promise<void>;
  stopRecording: () => Promise<string>; // Returns audio URL
  error: Error | null;
}
```

### Browser Support
```typescript
function checkBrowserSupport(): { supported: boolean; reason?: string } {
  if (!window.MediaRecorder) {
    return { supported: false, reason: 'MediaRecorder not supported' };
  }
  if (!navigator.mediaDevices?.getUserMedia) {
    return { supported: false, reason: 'getUserMedia not supported' };
  }
  // Check for specific codec support
  if (!MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
    // Try fallback formats
    if (!MediaRecorder.isTypeSupported('audio/webm')) {
      return { supported: false, reason: 'No supported audio format' };
    }
  }
  return { supported: true };
}
```

### Fallback UI
```tsx
{!isSupported && (
  <View className="p-4 bg-muted rounded-sketch">
    <Text className="font-caveat text-secondary">
      Voice recording is not supported in this browser.
      Try Chrome, Firefox, or Safari.
    </Text>
  </View>
)}
```

### MIME Types by Browser
| Browser | Recommended MIME |
|---------|-----------------|
| Chrome | audio/webm;codecs=opus |
| Firefox | audio/webm;codecs=opus |
| Safari | audio/mp4 |
| Edge | audio/webm;codecs=opus |

### File Locations
- VoiceRecorder: `components/capture/VoiceRecorder.tsx`
- New hooks: `hooks/useVoiceRecorder.ts`, `hooks/useWebRecorder.ts`
- Native hook: `hooks/useNativeRecorder.ts`

## Testing

### Manual Testing Required
- [ ] Chrome: permission prompt → recording works
- [ ] Firefox: permission prompt → recording works
- [ ] Safari: permission prompt → recording works
- [ ] Edge: permission prompt → recording works
- [ ] Unsupported browser → fallback message shown
- [ ] Deny permission → helpful error message
- [ ] 15-second auto-stop works
- [ ] Audio uploads and plays back
- [ ] PWA installs correctly
- [ ] PWA offline shows graceful message

### Browser Versions to Test
- Chrome 90+
- Firefox 85+
- Safari 14+
- Edge 90+

### Permission States
- [ ] Prompt → Ask user
- [ ] Granted → Start immediately
- [ ] Denied → Show how to enable

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
