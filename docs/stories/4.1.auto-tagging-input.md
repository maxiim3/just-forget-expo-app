# Story 4.1: Auto-Tagging on Input

## Status
Draft

## Story
**As a** user,
**I want** entries automatically tagged when I create them,
**so that** I never have to organize manually.

## Acceptance Criteria

1. New entries trigger auto-tag function
2. Tags stored in `labels` and `entry_labels` tables
3. Tagging is invisible (no manual tag UI)
4. Tagging runs async (non-blocking)
5. 3-5 relevant tags generated per entry
6. Tags available for filtering/search later
7. Graceful fallback if AI unavailable

## Tasks / Subtasks

- [ ] Task 1: Create auto-tag Edge Function (AC: 1, 5)
  - [ ] Create `supabase/functions/auto-tag/index.ts`
  - [ ] Accept entry content as input
  - [ ] Use AI to extract relevant tags
  - [ ] Return array of tag strings

- [ ] Task 2: Design AI prompt for tagging (AC: 5)
  - [ ] Create prompt that extracts themes/topics
  - [ ] Limit to 3-5 tags
  - [ ] Keep tags concise (1-2 words each)
  - [ ] Test prompt with various entry types

- [ ] Task 3: Store tags in database (AC: 2)
  - [ ] Check if tag already exists in labels table
  - [ ] Create new label if needed
  - [ ] Create entry_label relationship
  - [ ] Handle duplicates gracefully

- [ ] Task 4: Trigger tagging after entry creation (AC: 1, 4)
  - [ ] Call Edge Function after createEntry
  - [ ] Fire-and-forget (don't await)
  - [ ] Entry creation not blocked by tagging

- [ ] Task 5: Add tag status to entry (AC: 4)
  - [ ] Optional: `tagging_status` field (pending/complete/failed)
  - [ ] Or just fire-and-forget without tracking
  - [ ] Decision: simpler is better for MVP

- [ ] Task 6: Handle tagging failures (AC: 7)
  - [ ] Catch AI service errors
  - [ ] Log failures for debugging
  - [ ] Entry remains functional without tags
  - [ ] Retry mechanism (optional for MVP)

- [ ] Task 7: Create tag retrieval API (AC: 6)
  - [ ] Query labels for an entry
  - [ ] Include in entry fetch or separate query
  - [ ] For future: filter entries by tag

## Dev Notes

### Auto-Tag Edge Function
```typescript
// supabase/functions/auto-tag/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import OpenAI from 'https://esm.sh/openai@4';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const openai = new OpenAI({ apiKey: Deno.env.get('OPENAI_API_KEY') });
const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

serve(async (req) => {
  const { entryId, content, userId } = await req.json();

  // Generate tags with AI
  const completion = await openai.chat.completions.create({
    model: 'gpt-3.5-turbo',
    messages: [{
      role: 'system',
      content: 'Extract 3-5 concise topic tags from the following text. Return only a JSON array of strings, nothing else.'
    }, {
      role: 'user',
      content: content
    }],
    temperature: 0.3,
  });

  const tags = JSON.parse(completion.choices[0].message.content);

  // Store tags
  for (const tagName of tags) {
    // Upsert label
    const { data: label } = await supabase
      .from('labels')
      .upsert({
        user_id: userId,
        name: tagName.toLowerCase(),
        type: 'tag'
      }, { onConflict: 'user_id,name' })
      .select()
      .single();

    // Create entry_label relationship
    await supabase
      .from('entry_labels')
      .insert({
        entry_id: entryId,
        label_id: label.id
      })
      .onConflict('entry_id,label_id')
      .ignore();
  }

  return new Response(JSON.stringify({ tags }));
});
```

### AI Prompt Design
```
System: You are a tagging assistant. Extract 3-5 concise topic tags from user text.
Rules:
- Tags should be 1-2 words each
- Use lowercase
- Focus on themes, topics, actions, or categories
- Be specific but not too narrow
- Return ONLY a JSON array like ["tag1", "tag2", "tag3"]

Examples:
- "Buy milk and eggs tomorrow" → ["shopping", "groceries", "reminder"]
- "Meeting with John about Q3 budget" → ["meeting", "budget", "work", "planning"]
- "Great idea for a blog post about React hooks" → ["idea", "blog", "react", "coding"]
```

### Fire-and-Forget Pattern
```typescript
// In store or entry creation logic
async function createEntry(content: string) {
  // 1. Create entry in database
  const entry = await supabase.from('entries').insert(...).select().single();

  // 2. Trigger tagging (don't await)
  supabase.functions.invoke('auto-tag', {
    body: { entryId: entry.id, content, userId: user.id }
  }).catch(console.error); // Log but don't block

  return entry;
}
```

### Labels Table Schema
```sql
-- Ensure unique constraint for upsert
CREATE UNIQUE INDEX labels_user_name_unique
  ON labels (user_id, name);
```

### Querying Entry Tags
```typescript
// Get entry with tags
const { data } = await supabase
  .from('entries')
  .select(`
    *,
    entry_labels (
      labels (name, type)
    )
  `)
  .eq('id', entryId)
  .single();

// Flatten tags
const tags = data.entry_labels.map(el => el.labels.name);
```

### File Locations
- Edge Function: `supabase/functions/auto-tag/index.ts`
- Store: `lib/store.ts`
- Entry type: `lib/supabase.ts` (add tags relation)

### Cost Estimation
- GPT-3.5-turbo: ~$0.0005 per entry tagging
- 100 entries/day ≈ $0.05/day ≈ $1.50/month

## Testing

### Manual Testing Required
- [ ] Create entry → tags generated in background
- [ ] Check labels table → tags created
- [ ] Check entry_labels → relationships exist
- [ ] Same tag on multiple entries → reuses label
- [ ] AI unavailable → entry still created, no tags
- [ ] Query entry → tags included in response

### Tag Quality Testing
- [ ] Short text → still generates relevant tags
- [ ] Long text → focused tags, not too many
- [ ] Different topics → appropriate tags
- [ ] Non-English → handle gracefully (or support)

### Edge Cases
- [ ] Empty content → handle gracefully
- [ ] Very long content → truncate for AI
- [ ] Special characters → sanitize tags
- [ ] Duplicate tags in response → deduplicate

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
