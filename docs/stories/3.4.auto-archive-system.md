# Story 3.4: Auto-Archive System

## Status
Draft

## Story
**As a** user,
**I want** old entries to auto-archive after a configurable period,
**so that** my inbox stays clean without manual effort.

## Acceptance Criteria

1. Opt-in auto-archive setting (disabled by default)
2. Configurable period: 7, 14, 30 days (default: 7)
3. Notification 1 day before auto-archive
4. User can postpone individual entries
5. Auto-archived entries still accessible in archived section
6. Settings UI to configure auto-archive
7. Background job runs reliably

## Tasks / Subtasks

- [ ] Task 1: Add auto-archive settings to user profile (AC: 1, 2)
  - [ ] Create user_settings table or JSONB field
  - [ ] Fields: auto_archive_enabled, auto_archive_days
  - [ ] Default: disabled, 7 days

- [ ] Task 2: Create settings UI (AC: 1, 2, 6)
  - [ ] Add Settings screen or section
  - [ ] Toggle for auto-archive on/off
  - [ ] Dropdown/picker for archive period
  - [ ] Save settings to Supabase

- [ ] Task 3: Create auto-archive Edge Function (AC: 7)
  - [ ] Create `supabase/functions/auto-archive/index.ts`
  - [ ] Query entries older than configured period
  - [ ] Set archived = true on matching entries
  - [ ] Return count of archived entries

- [ ] Task 4: Schedule background job (AC: 7)
  - [ ] Use Supabase pg_cron or external scheduler
  - [ ] Run daily at consistent time
  - [ ] Handle timezone considerations
  - [ ] Log job execution

- [ ] Task 5: Implement notification system (AC: 3)
  - [ ] Query entries expiring in 1 day
  - [ ] Send push notification or in-app alert
  - [ ] "X entries will be archived tomorrow"
  - [ ] Link to review entries

- [ ] Task 6: Add postpone functionality (AC: 4)
  - [ ] Add "Keep" or "Postpone" action on entries
  - [ ] Reset/extend the archive countdown
  - [ ] Could use `postponed_until` field

- [ ] Task 7: Ensure archived access (AC: 5)
  - [ ] Verify archived section works
  - [ ] Auto-archived entries same as manual
  - [ ] Can unarchive if needed

## Dev Notes

### User Settings Schema
```sql
-- Option 1: Separate table
CREATE TABLE user_settings (
  user_id UUID REFERENCES auth.users(id) PRIMARY KEY,
  auto_archive_enabled BOOLEAN DEFAULT FALSE,
  auto_archive_days INTEGER DEFAULT 7,
  notification_enabled BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Option 2: JSONB in profiles table
ALTER TABLE profiles
ADD COLUMN settings JSONB DEFAULT '{"auto_archive_enabled": false, "auto_archive_days": 7}';
```

### Auto-Archive Edge Function
```typescript
// supabase/functions/auto-archive/index.ts
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const supabase = createClient(
  Deno.env.get('SUPABASE_URL')!,
  Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!
);

Deno.serve(async () => {
  // Get users with auto-archive enabled
  const { data: settings } = await supabase
    .from('user_settings')
    .select('user_id, auto_archive_days')
    .eq('auto_archive_enabled', true);

  let totalArchived = 0;

  for (const setting of settings || []) {
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - setting.auto_archive_days);

    const { count } = await supabase
      .from('entries')
      .update({ archived: true })
      .eq('user_id', setting.user_id)
      .eq('archived', false)
      .lt('created_at', cutoffDate.toISOString())
      .select('*', { count: 'exact', head: true });

    totalArchived += count || 0;
  }

  return new Response(JSON.stringify({ archived: totalArchived }));
});
```

### Scheduling with pg_cron
```sql
-- Enable pg_cron extension
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Schedule daily at 3 AM UTC
SELECT cron.schedule(
  'auto-archive-daily',
  '0 3 * * *',
  $$
  SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/auto-archive',
    headers := '{"Authorization": "Bearer service_role_key"}'::jsonb
  );
  $$
);
```

### Postpone Implementation
```typescript
// Add postponed_until field to entries
interface Entry {
  // ... existing fields
  postponed_until?: string; // ISO date
}

// Postpone an entry by 7 days
async function postponeEntry(entryId: string) {
  const postponedUntil = new Date();
  postponedUntil.setDate(postponedUntil.getDate() + 7);

  await supabase
    .from('entries')
    .update({ postponed_until: postponedUntil.toISOString() })
    .eq('id', entryId);
}

// Update auto-archive query to respect postponed_until
.or(`postponed_until.is.null,postponed_until.lt.${now}`)
```

### Settings UI Component
```tsx
// components/settings/AutoArchiveSettings.tsx
function AutoArchiveSettings() {
  const [enabled, setEnabled] = useState(false);
  const [days, setDays] = useState(7);

  return (
    <View className="p-4">
      <Text className="font-marker text-xl">Auto-Archive</Text>

      <View className="flex-row justify-between items-center mt-4">
        <Text className="font-caveat">Enable auto-archive</Text>
        <Switch value={enabled} onValueChange={setEnabled} />
      </View>

      {enabled && (
        <View className="mt-4">
          <Text className="font-caveat">Archive entries after:</Text>
          <Picker selectedValue={days} onValueChange={setDays}>
            <Picker.Item label="7 days" value={7} />
            <Picker.Item label="14 days" value={14} />
            <Picker.Item label="30 days" value={30} />
          </Picker>
        </View>
      )}
    </View>
  );
}
```

### File Locations
- Edge Function: `supabase/functions/auto-archive/index.ts`
- Settings UI: `components/settings/AutoArchiveSettings.tsx`
- Settings screen: `app/settings.tsx` (new)
- Store: `lib/store.ts` (add settings)

## Testing

### Manual Testing Required
- [ ] Settings toggle works
- [ ] Period selector works
- [ ] Create entry → wait for period → gets archived
- [ ] Postpone entry → not archived after original period
- [ ] Notification received 1 day before
- [ ] Auto-archived entry accessible in archived section
- [ ] Unarchive works on auto-archived entry
- [ ] Disabled setting → no auto-archive happens

### Edge Cases
- [ ] Entry created just before cutoff → not archived
- [ ] User changes setting mid-cycle → respects new setting
- [ ] Multiple entries → all eligible ones archived
- [ ] Timezone edge cases (midnight boundaries)

### Cron Job Testing
- [ ] Job runs at scheduled time
- [ ] Job handles errors gracefully
- [ ] Job logs are accessible
- [ ] Manual trigger works

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-12 | 0.1 | Initial draft | John (PM) |

---

## Dev Agent Record

### Agent Model Used
_To be filled by dev agent_

### Debug Log References
_To be filled by dev agent_

### Completion Notes List
_To be filled by dev agent_

### File List
_To be filled by dev agent_

---

## QA Results
_To be filled by QA agent_
